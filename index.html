<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MapTiler PWA Map</title>
  <!-- MapTiler SDK CSS -->
  <link href='https://cdn.maptiler.com/maptiler-sdk-js/v3.9.0/maptiler-sdk.css' rel='stylesheet' />

  <!-- PWA Manifest -->
  <link rel="manifest" href="manifest.json">
  <!-- Theme color for PWA -->
  <meta name="theme-color" content="#007cbf">
  <style>
    body { margin: 0; padding: 0; }
    #map { position: absolute; top: 0; bottom: 0; width: 100%; }
  </style>
</head>
<body>
  <div id="map"></div>

  <!-- MapTiler SDK JS -->
  <script src="https://cdn.maptiler.com/maptiler-sdk-js/v3.9.0/maptiler-sdk.umd.min.js"></script>
  <script>
    // Set your MapTiler API key
    maptilersdk.config.apiKey = 'kL6oIUVznNOluKtvC2BJ';

    // Initialize the map
    const map = new maptilersdk.Map({
      container: 'map',  // HTML element ID
      style: maptilersdk.MapStyle.STREETS,  // Use a built-in style (or custom URL)
      center: [173.617976, -40.437534],  // [longitude, latitude] â€“ e.g., Ostrava
      zoom: 5.5  // Starting zoom
    });

    // Expose globally for Flutter WebView access
    window.maptilerMap = map;  // Use 'window.maptilerMap' to avoid conflicts

    // In <script> after map init (in index.html or map-script.js)
let boundarySourceId = 'boundaries-source';
let boundaryLayerId = 'boundaries-layer';

// Function to add/remove boundaries (called from Flutter)
function addBoundaries(geoJson) {
  if (!map) {
    console.error('Map not ready');
    return;
  }

  // Remove existing layer if present (for updates)
  if (map.getLayer(boundaryLayerId)) {
    map.removeLayer(boundaryLayerId);
  }
  if (map.getSource(boundarySourceId)) {
    map.removeSource(boundarySourceId);
  }

  // Add GeoJSON source and layer
  map.addSource(boundarySourceId, {
    type: 'geojson',
    data: geoJson, // Passed from Flutter as JSON string (parsed auto)
  });

  map.addLayer({
    id: boundaryLayerId,
    type: 'fill', // For polygons; use 'line' for boundaries
    source: boundarySourceId,
    paint: {
      'fill-color': '#088', // Blue fill
      'fill-opacity': 0.4,
      'fill-outline-color': '#000', // Black outline
    },
    // Optional: Filter by zoom or properties
    filter: ['==', '$type', 'Polygon'], // Only polygons
  });

  console.log('Boundaries added:', geoJson.features.length);
}

// Example interactivity: Click to highlight boundary
map.on('click', boundaryLayerId, (e) => {
  const features = map.queryRenderedFeatures(e.point, { layers: [boundaryLayerId] });
  if (features.length > 0) {
    const feature = features[0];
    // Highlight (toggle opacity or color)
    map.setPaintProperty(boundaryLayerId, 'fill-opacity', 0.8);
    // Send feature props back to Flutter (e.g., boundary ID)
    window.flutter_inappwebview.callHandler('BoundaryClickHandler', {
      id: feature.properties.id, // Assume your GeoJSON has 'id' prop
      coords: e.lngLat,
    });
  }
});

// Hover effect for scalability (debounced)
map.on('mouseenter', boundaryLayerId, () => {
  map.getCanvas().style.cursor = 'pointer';
});
map.on('mouseleave', boundaryLayerId, () => {
  map.getCanvas().style.cursor = '';
});

// Expose for Flutter (if needed)
window.addBoundaries = addBoundaries;


  </script>

  <!-- Register Service Worker -->
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/sw.js')
        .then((reg) => console.log('SW registered:', reg))
        .catch((err) => console.log('SW registration failed:', err));
    }
  </script>
</body>
</html>